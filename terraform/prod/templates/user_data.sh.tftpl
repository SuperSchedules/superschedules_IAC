#!/usr/bin/env bash
set -euxo pipefail

REGION=${region}
APP_DIR=/opt/superschedules
mkdir -p "$APP_DIR"

# Create swap file (2GB for t3.micro with 1GB RAM)
if [ ! -f /swapfile ]; then
  dd if=/dev/zero of=/swapfile bs=1M count=2048 status=progress
  chmod 600 /swapfile
  mkswap /swapfile
  swapon /swapfile
  echo '/swapfile none swap sw 0 0' >> /etc/fstab
  # Set swappiness to 10 (prefer RAM, use swap as backup)
  sysctl vm.swappiness=10
  echo 'vm.swappiness=10' >> /etc/sysctl.conf
fi

# Install Docker and compose plugin
if command -v apt-get >/dev/null 2>&1; then
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y
  apt-get install -y ca-certificates curl gnupg lsb-release awscli
  install -m 0755 -d /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  chmod a+r /etc/apt/keyrings/docker.gpg
  echo \
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" | \
    tee /etc/apt/sources.list.d/docker.list >/dev/null
  apt-get update -y
  apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  systemctl enable docker
  systemctl start docker
fi

# ECR login
aws ecr get-login-password --region "$REGION" | docker login --username AWS --password-stdin ${aws_account_id}.dkr.ecr.${region}.amazonaws.com

cat > "$APP_DIR/docker-compose.yml" <<'YAML'
services:
  frontend:
    image: ${nginx_image}
    ports:
      - "80:80"
  django:
    image: ${django_image}
    ports:
      - "8000:8000"
    environment:
      - DJANGO_SETTINGS_MODULE=${django_settings_module}
      - DB_HOST=${db_host}
      - DB_PORT=${db_port}
      - DB_NAME=${db_name}
      - DB_USER=${db_username}
      - DB_PASSWORD=${db_password}
      - AWS_REGION=${region}
      - AWS_S3_BUCKET=${static_bucket}
      - ALB_HOST=${alb_dns_name}
      - DEBUG=False
      - LLM_PROVIDER=bedrock
      - AWS_BEDROCK_REGION=${region}
      - COLLECTOR_URL=http://collector:8001
      - NAVIGATOR_URL=http://navigator:8004
    depends_on:
      - wait-for-db
  collector:
    image: ${collector_image}
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=postgresql://${db_username}:${db_password}@${db_host}:${db_port}/${db_name}
      - AWS_REGION=${region}
      - AWS_S3_BUCKET=${static_bucket}
    depends_on:
      - wait-for-db
  navigator:
    image: ${fastapi_image}
    ports:
      - "8004:8004"
    environment:
      - DB_HOST=${db_host}
      - DB_PORT=${db_port}
      - DB_NAME=${db_name}
      - DB_USER=${db_username}
      - DB_PASSWORD=${db_password}
      - AWS_REGION=${region}
      - AWS_S3_BUCKET=${static_bucket}
    depends_on:
      - wait-for-db
  wait-for-db:
    image: public.ecr.aws/bitnami/postgresql:15
    command: ["/bin/bash", "-lc", "until pg_isready -h ${db_host} -p ${db_port} -U ${db_username}; do echo waiting for db; sleep 3; done"]
YAML

cat > /etc/systemd/system/superschedules.service <<UNIT
[Unit]
Description=Superschedules stack
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/superschedules
ExecStartPre=/bin/bash -c 'aws ecr get-login-password --region ${region} | docker login --username AWS --password-stdin ${aws_account_id}.dkr.ecr.${region}.amazonaws.com'
ExecStart=/usr/bin/docker compose -f /opt/superschedules/docker-compose.yml up -d --pull always
ExecStop=/usr/bin/docker compose -f /opt/superschedules/docker-compose.yml down
TimeoutStartSec=0
Restart=on-failure

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload
systemctl enable superschedules
systemctl start superschedules

# Wait for services to be healthy
sleep 30

# Enable pgvector extension (idempotent)
docker exec $(docker ps -qf "name=django") python manage.py shell -c "from django.db import connection; cursor = connection.cursor(); cursor.execute('CREATE EXTENSION IF NOT EXISTS vector;'); print('pgvector extension enabled')" || echo "pgvector extension creation failed"

# Run Django migrations (creates tables and enables pgvector)
docker exec $(docker ps -qf "name=django") python manage.py migrate --noinput || echo "Migration failed - may need manual intervention"

echo "Bootstrapping complete"

